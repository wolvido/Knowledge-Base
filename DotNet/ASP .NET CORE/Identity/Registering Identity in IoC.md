Before you can manipulate the User and Role [[Identity Models]] we need to add Identity in the [[IoC]].
# How-To:
- First, nuget install `Asp.NetCore.Identity.EntityFrameworkCore`
#### Register the service in Program.cs:
- or register in [[Arrange Program.cs]].
###### Make sure when registering the service, you register it after `DbContext` registration
- write it below: `services.AddDbContext...`
This is because Identity will of course use `DbContext`.
```c#
//`SampleUser` and `SampleRole` is just sample Identity Models, change it as necessary, and `SampleDbContext` is also a sample DbContext.
services.AddIdentity<SampleUser, SampleRole>(options => {
	//here we register the password requirements
	options.Password.RequiredLength = 5; //number of characters required in password
	options.Password.RequireNonAlphanumeric = true; //non-alphanumeric characters (symbols) required in password
	options.Password.RequireUppercase = true; //at least one upper case character required in password
	options.Password.RequireLowercase = true; //at least one lower case character required in password
	options.Password.RequireDigit = true; //at least one digit required in password
	options.Password.RequiredUniqueChars = 1; //at least 1 distinct character in password
})
	//Then we have to configure which DbContext will SampleUser and SampleRole use in general
	.AddEntityFrameworkStores<SampleDbContext> //the IdentityUser and IdentityRole will use SampleDbContext.
		//make sure you dont confuse `SampleDbContext` with the wrong database, make sure it is the the DbContext with the identity.
	
	//then we add the default tokens, will be explained below.
	.AddDefaultTokenProviders();
	
	//Then also you don't need to create a Repository for SampleUser, SampleRole- 
	//They can be automatically generated by adding
	.AddUserStore<UserStore<SampleUser, SampleRole, SampleDbContext, Guid>>() //UserStore is repo for Identity User
		//Guid is the ID type of IdentityUser, change it as necessary.
	.AddRoleStore<RoleStore<SampleRole, SampleUser, SampleDbContext, Guid>>() //RoleStore is repo for Identity User
		//Guid is the ID type of IdentityRole, change it as necessary.
```
There is no need to create custom repository class, it will be created automatically by this configuration.

The `AddDefaultTokenProviders();` registers the default random tokens for the program, for example when you log in, we need an OTP, or an email confirmations. Tokens need to be generated to confirm the identity, ASP.NET has built in default token providers for emails, phone numbers, etc..
#### Question: Why not let model validation handle the password configuration?
The model validation and the Identity password validation are two separate validations, and stored in separate object, so it will be best to consolidate the errors by doing:
```c#
public Task<IActionresult> Register(SampleDTO SampleDTO)
{
	SampleIdentityUser user = //assuming youve alread set this up, see Identity Manager note for clear explain
		
	IdentityResult result = await __userManager.CreateAsync(user, SampleDTO.Password); 
		
	if (result.Suceeded)
	{
		//if no error then proceed
	}
	else
	{
		//if some mistake, then add the errors in model state
		foreach (Identity error in result.Errors)
		{
			ModelState.AddModelError("RegisterError", error.Description);
				//This way the errors in both validations will be consolidated
				//"RegisterError" is just a key, change it as necessary, the value is the error description.
			
				return View(SampleDTO);
		}
	}
}
```
If this sample makes no sense, read the whole: [[Identity Manager]].